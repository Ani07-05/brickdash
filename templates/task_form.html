{% extends 'base.html' %}

{% block title %}{% if task %}Edit{% else %}Create{% endif %} Task{% endblock %}
{% block header %}{% if task %}EDIT TASK{% else %}CREATE TASK{% endif %}{% endblock %}

{% block content %}
<div class="form-card">
    <h2>{% if task %}Edit Task{% else %}Create Task{% endif %}</h2>
    
    <form method="POST" id="taskForm">
        <div class="form-row">
            <div class="form-group">
                <label for="title">Title</label>
                <input type="text" id="title" name="title" class="form-control" 
                       value="{{ task.title if task else '' }}" required
                       placeholder="Short task title">
            </div>
            
            <div class="form-group">
                <label for="order_id">Order ID (Optional)</label>
                <input type="text" id="order_id" name="order_id" class="form-control" 
                       value="{{ task.order_id if task and task.order_id else '' }}"
                       placeholder="e.g., ORD1001">
            </div>
        </div>
        
        <div class="form-group">
            <label for="description">Description</label>
            <textarea id="description" name="description" class="form-control" 
                      placeholder="Detailed task description">{{ task.description if task else '' }}</textarea>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="task_type">Task Type</label>
                <select id="task_type" name="task_type" class="form-control" onchange="suggestEmployee()">
                    <option value="General">General</option>
                    <option value="Loading">Loading</option>
                    <option value="Delivery">Delivery</option>
                    <option value="Quality Check">Quality Check</option>
                    <option value="Packaging">Packaging</option>
                    <option value="Maintenance">Maintenance</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="assigned_to">
                    Assigned to
                    <button type="button" class="btn btn-sm btn-info ml-1" onclick="suggestEmployee()" title="Auto-suggest based on rotation">
                        <i class="fas fa-magic"></i> Suggest
                    </button>
                </label>
                <select id="assigned_to" name="assigned_to" class="form-control">
                    <option value="">-- Unassigned --</option>
                    {% for employee in employees %}
                    <option value="{{ employee.id }}" 
                            {% if task and task.assigned_to == employee.id %}selected{% endif %}>
                        {{ employee.name }} ({{ employee.role }})
                    </option>
                    {% endfor %}
                </select>
                <small id="suggestion_hint" class="text-muted" style="display: none;"></small>
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="priority">Priority</label>
                <select id="priority" name="priority" class="form-control" required>
                    <option value="Low" {% if task and task.priority == 'Low' %}selected{% endif %}>Low</option>
                    <option value="Medium" {% if not task or task.priority == 'Medium' %}selected{% endif %}>Medium</option>
                    <option value="High" {% if task and task.priority == 'High' %}selected{% endif %}>High</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="status">Status</label>
                <select id="status" name="status" class="form-control" required>
                    <option value="Not Started" {% if not task or task.status == 'Not Started' %}selected{% endif %}>Not Started</option>
                    <option value="In Progress" {% if task and task.status == 'In Progress' %}selected{% endif %}>In Progress</option>
                    <option value="Completed" {% if task and task.status == 'Completed' %}selected{% endif %}>Completed</option>
                </select>
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="progress">Progress (%)</label>
                <input type="number" id="progress" name="progress" class="form-control" 
                       min="0" max="100" value="{{ task.progress if task else 0 }}"
                       placeholder="0">
            </div>
            
            <div class="form-group">
                <label for="due_date">Due Date</label>
                <input type="date" id="due_date" name="due_date" class="form-control" 
                       value="{{ task.due_date.strftime('%Y-%m-%d') if task and task.due_date else '' }}">
            </div>
        </div>
        
        <div class="d-flex gap-1 mt-2">
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i> Save Task
            </button>
            <a href="{{ url_for('tasks') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back
            </a>
            <a href="{{ url_for('task_rotation') }}" class="btn btn-outline">
                <i class="fas fa-sync-alt"></i> View Rotation Matrix
            </a>
        </div>
    </form>
</div>

<style>
.ml-1 {
    margin-left: 0.5rem;
}

#suggestion_hint {
    margin-top: 5px;
    font-size: 0.85rem;
    color: #28a745;
}

.btn-outline {
    border: 1px solid var(--primary-color);
    background: transparent;
    color: var(--primary-color);
}

.btn-outline:hover {
    background: var(--primary-color);
    color: white;
}
</style>
{% endblock %}

{% block scripts %}
<script>
function suggestEmployee() {
    const taskType = document.getElementById('task_type').value;
    const hint = document.getElementById('suggestion_hint');
    
    fetch(`/api/task-rotation/suggest?type=${encodeURIComponent(taskType)}`)
        .then(response => response.json())
        .then(data => {
            if (data.suggested_employee) {
                const emp = data.suggested_employee;
                document.getElementById('assigned_to').value = emp.id;
                hint.textContent = `âœ“ Suggested: ${emp.name} (${emp.type_assignments} ${taskType} tasks, ${emp.total_assignments} total in last 30 days)`;
                hint.style.display = 'block';
                hint.style.color = '#28a745';
            }
        })
        .catch(err => {
            hint.textContent = 'Could not get suggestion';
            hint.style.display = 'block';
            hint.style.color = '#dc3545';
        });
}

// Log assignment when form is submitted
document.getElementById('taskForm').addEventListener('submit', function() {
    const employeeId = document.getElementById('assigned_to').value;
    const taskType = document.getElementById('task_type').value;
    
    if (employeeId) {
        fetch('/api/task-rotation/log', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ employee_id: employeeId, task_type: taskType })
        });
    }
});

// Auto-suggest on page load for new tasks
{% if not task %}
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(suggestEmployee, 500);
});
{% endif %}
</script>
{% endblock %}
